@page "{pageNumber:int?}"
@{
    Layout = "_AdminLayout";
}
@model PRN222_Final_Project.Pages.Manager.Staff_ManageBookModel
@{
}
<head>
    <link rel="stylesheet" href="~/css/staff_managebook.css" asp-append-version="true" />
</head>
<div class="header">
    <span>Quản Lý Sách</span>
    <span class="user-info"><i class="fas fa-user me-2"></i> Staff</span>
</div>

<!-- Book Management -->
<div class="book-management">
    <div class="search-bar">
        <form method="get" action="/Manager/Staff-ManageBook" class="row g-2">
            <div class="col">
                <input type="text" class="form-control" placeholder="Tìm kiếm sách..." id="searchInput" asp-for="SearchTerm">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Tìm</button>
            </div>
        </form>
        <button class="btn btn-add" data-bs-toggle="modal" data-bs-target="#bookModalAdd">
            <i class="fas fa-plus me-2"></i>Thêm Sách
        </button>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Tên Sách</th>
                <th>Tác Giả</th>
                <th>Giá</th>
                <th>Số Lượng</th>
                <th>Hành Động</th>
            </tr>
        </thead>
        <tbody id="bookTable">
            @foreach (var book in @Model.Books)
            {
                <tr>
                    <td>@book.ProductId</td>
                    <td>@book.Title</td>
                    <td>@book.Author</td>
                    <td>@book.Price</td>
                    <td>@book.Stock</td>
                    <td>
                        <button class="btn btn-warning btn-edit-book"
                                data-id="@book.ProductId"
                                data-title="@book.Title"
                                data-author="@book.Author"
                                data-price="@book.Price"
                                data-stock="@book.Stock"
                                data-description="@book.Description"
                                data-category="@book.CategoryId"
                                data-image="@book.ImageUrl"
                                data-bs-toggle="modal"
                                data-bs-target="#bookModalEdit">
                            Sửa
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <nav>
        <ul class="pagination">
            @{
                int totalPages = (int)Math.Ceiling(Model.TotalCount / (double)Model.PageSize);
            }
            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(Model.CurrentPage == i ? "active" : "")">
                    <a class="page-link"
                       asp-page="/Manager/Staff-ManageBook"
                       asp-route-pageNumber="@i"
                       asp-route-searchTerm="@Model.SearchTerm">@i</a>
                </li>
            }
        </ul>
    </nav>
</div>

<!-- Modal -->
<div class="modal fade" id="bookModalAdd" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm Sách</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" id="addBookForm">
                    <div class="image-input-wrapper mb-3">
                        <img src="https://via.placeholder.com/150" class="image-preview" id="imagePreview" alt="Book Image">
                        <input type="file" id="bookImage" name="ImageFile" accept="image/*" onchange="previewImage(event)">
                        <label for="bookImage" class="image-label"></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tên Sách</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thể Loại</label>
                        <select class="form-select mb-3" name="categoryId" required>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.CategoryId">@category.CategoryName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tác Giả</label>
                        <input type="text" class="form-control" name="author" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Giá</label>
                        <input type="number" class="form-control" name="price" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số Lượng</label>
                        <input type="number" class="form-control" name="stock" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô Tả</label>
                        <textarea class="form-control" name="description" rows="4"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="bookModalEdit" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm Sách</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" id="editBookForm">
                    <input type="hidden" name="bookId" id="bookId" />
                    <div class="image-input-wrapper mb-3">
                        <img src="https://via.placeholder.com/150" class="image-preview" id="imagePreviewEdit" alt="Book Image">
                        <input type="file" id="bookImageEdit" name="ImageFile" accept="image/*" onchange="previewImage(event)">
                        <label for="bookImageEdit" class="image-label"></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tên Sách</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thể Loại</label>
                        <select class="form-select mb-3" name="categoryId" required>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.CategoryId">@category.CategoryName</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tác Giả</label>
                        <input type="text" class="form-control" name="author" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Giá</label>
                        <input type="number" class="form-control" name="price" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Số Lượng</label>
                        <input type="number" class="form-control" name="stock" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô Tả</label>
                        <textarea class="form-control" name="description" rows="4"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".btn-edit-book").forEach(button => {
            button.addEventListener("click", function () {
                // Lấy dữ liệu từ attributes
                const bookId = this.getAttribute("data-id");
                const title = this.getAttribute("data-title");
                const author = this.getAttribute("data-author");
                const price = this.getAttribute("data-price");
                const stock = this.getAttribute("data-stock");
                const description = this.getAttribute("data-description") || '';
                const categoryId = this.getAttribute("data-category");
                const imageUrl = this.getAttribute("data-image");

                // Cập nhật modal edit
                const modal = document.querySelector('#bookModalEdit');
                modal.querySelector('.modal-title').textContent = "Chỉnh Sửa Sách";
                const form = modal.querySelector('#editBookForm');

                // Cập nhật các field
                form.querySelector('input[name="bookId"]').value = bookId;
                form.querySelector('input[name="name"]').value = title;
                form.querySelector('input[name="author"]').value = author;
                form.querySelector('input[name="price"]').value = price;
                form.querySelector('input[name="stock"]').value = stock;
                form.querySelector('textarea[name="description"]').value = description;
                form.querySelector('select[name="categoryId"]').value = categoryId;

                // Cập nhật ảnh
                const imagePreview = modal.querySelector('#imagePreviewEdit');
                const bookImageEdit = modal.querySelector('#bookImageEdit');
                imagePreview.src = imageUrl;
                bookImageEdit.value = imageUrl;
            });
        });
    });


    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const modal = event.target.closest('.modal');
                const imagePreview = modal.querySelector('#imagePreview');
                const imagePreviewEdit = modal.querySelector('#imagePreviewEdit');

                if (imagePreview) {
                    imagePreview.src = e.target.result;
                }
                if (imagePreviewEdit) {
                    imagePreviewEdit.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }
    }

</script>
